<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Librarian Panel - MMU Library</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; }
        .header-banner {
            background-color: #004a99;
            color: white;
            padding: 25px;
            text-align: center;
            font-size: 3em;
            font-weight: bold;
            position: relative;
        }
        .logout-link {
            position: absolute;
            right: 30px;
            top: 35px;
            color: white;
            font-size: 0.4em;
            text-decoration: none;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 8px;
        }
        .container { width: 95%; max-width: 1300px; margin: 30px auto; }
        .section-box {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .status-available { font-weight: bold; color: #28a745; }
        .status-borrowed { font-weight: bold; color: #d9534f; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background-color: #f8f9fa; }
        input[type="text"], input[type="password"] {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .btn-action {
            padding: 7px 14px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            border: none;
            cursor: pointer;
        }
        .btn-add { background: #28a745; }
        .btn-save { background: #6c757d; }
        .btn-delete { background: #d9534f; }
        .protected-text { color: #888; font-style: italic; }
        .alert-box {
            border-left: 10px solid #d9534f;
            background: #fff5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .change-pwd-link {
            font-weight: bold;
            color: #004a99;
            text-decoration: none;
        }
    </style>
</head>
<body>

<div class="header-banner">
    Librarian Panel
    <a href="{{ url_for('librarian.logout') }}" class="logout-link">Logout</a>
</div>

<div class="container">

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, message in messages %}
            <div class="section-box">{{ message }}</div>
        {% endfor %}
    {% endwith %}

    <!-- üîê PASSWORD CHANGE ENFORCEMENT -->
    {% if session.get('force_pwd_change') %}
    <div class="alert-box">
        <strong>üîê Password Change Required</strong><br><br>
        {% if session.get('pwd_reason') == 'first' %}
            This is your <b>first login</b>. You must change your password before continuing.
        {% else %}
            Your password has <b>expired (6 months)</b>. Please update it to continue.
        {% endif %}
        <br><br>
        <a href="{{ url_for('reader.change_password') }}" class="change-pwd-link">
            üëâ Change My Password
        </a>
    </div>
    {% else %}
        <p class="protected-text">
            üîí Password change is allowed only once every 6 months.
        </p>
    {% endif %}

    <!-- ================= OVERDUE REPORT ================= -->
    <div class="section-box">
        <h3>‚ö†Ô∏è Overdue Report</h3>
        {% if overdue_list %}
        <table>
            <thead>
                <tr><th>Reader</th><th>Book</th><th>Due Date</th></tr>
            </thead>
            <tbody>
                {% for item in overdue_list %}
                <tr>
                    <td>{{ item.Username }}</td>
                    <td>{{ item.Title }}</td>
                    <td class="status-borrowed">{{ item.DueDate.strftime('%Y-%m-%d') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p>No overdue books found.</p>
        {% endif %}
    </div>

    <!-- ================= MEMBER MANAGEMENT ================= -->
    <div class="section-box">
        <h3>üë§ Member Management & Account Security</h3>

        {% if not session.get('force_pwd_change') %}
        <form action="{{ url_for('librarian.create_member') }}" method="POST"
              style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="text" name="username" placeholder="New Username" required>
            <input type="password" name="password" placeholder="New Password" required>
            <input type="hidden" name="role" value="Reader">
            <button class="btn-action btn-add">Create Reader</button>
        </form>
        {% endif %}

        <table>
            <thead>
                <tr><th>Username</th><th>Role</th><th>Password</th><th>Account</th></tr>
            </thead>
            <tbody>
                {% for member in members %}
                <tr>
                    <td>{{ member.Username }}</td>
                    <td>{{ member.Role }}</td>
                    <td>
                        {% if member.Username != session['username'] and not session.get('force_pwd_change') %}
                        <form action="{{ url_for('librarian.reset_password') }}" method="POST">
                            <input type="hidden" name="username" value="{{ member.Username }}">
                            <input type="password" name="new_password" required>
                            <button class="btn-action btn-save">Update</button>
                        </form>
                        {% else %}
                        <span class="protected-text">Use Change Password</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if member.Username != session['username'] %}
                        <a href="{{ url_for('librarian.delete_user', username=member.Username) }}"
                           class="btn-action btn-delete">Remove</a>
                        {% else %}
                        <span class="protected-text">Protected</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- ================= INVENTORY & BOOK MANAGEMENT ================= -->
    <div class="section-box">
        <h3>üì¶ Inventory & Book Management</h3>

        {% if not session.get('force_pwd_change') %}

        <!-- ADD BOOK -->
        <form action="{{ url_for('librarian.add_book') }}" method="POST"
            style="display:flex; gap:10px; margin-bottom:20px; align-items:center;">
            <input type="text" name="title" placeholder="Book Title" required style="flex:2;">
            <input type="text" name="author" placeholder="Author Name" required style="flex:1;">

            <select name="category" required>
                <option value="">Select Category</option>
                <option value="Fiction">Fiction</option>
                <option value="Science Fiction">Science Fiction</option>
                <option value="Fantasy">Fantasy</option>
                <option value="Technology">Technology</option>
            </select>

            <button class="btn-action btn-add">Add Book</button>
        </form>

        <table>
            <thead>
                <tr>
                    <th>Title & Author</th>
                    <th>Category</th>
                    <th>Status</th>
                    <th>Toggle</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for book in inventory %}
                <tr>
                    <td>
                        <form action="{{ url_for('librarian.edit_book', book_id=book.BookID) }}"
                            method="POST" style="display:flex; gap:5px;">
                            <input type="text" name="title" value="{{ book.Title }}" required>
                            <input type="text" name="author" value="{{ book.Author }}" required>
                    </td>

                    <td>
                        <select name="category" required>
                            {% set categories = ['Fiction', 'Science Fiction', 'Fantasy', 'Technology'] %}
                            {% for cat in categories %}
                                <option value="{{ cat }}"
                                    {% if book.Category == cat %}selected{% endif %}>
                                    {{ cat }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>

                    <td class="{{ 'status-available' if book.Available else 'status-borrowed' }}">
                        {{ "Available" if book.Available else "Borrowed" }}
                    </td>

                    <td>
                        <a href="{{ url_for('librarian.toggle_status', book_id=book.BookID) }}">
                            Change Status
                        </a>
                    </td>

                    <td>
                        <button class="btn-action btn-save">Save</button>
                        </form>

                        <a href="{{ url_for('librarian.delete_book', book_id=book.BookID) }}"
                        class="btn-action btn-delete"
                        onclick="return confirm('Delete book?')">
                            Delete
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% else %}
            <p class="protected-text">
                Inventory management is disabled until password change is completed.
            </p>
        {% endif %}
    </div>


</div>
</body>
</html>
